var ge=Object.defineProperty,be=Object.defineProperties;var ye=Object.getOwnPropertyDescriptors;var ne=Object.getOwnPropertySymbols;var he=Object.prototype.hasOwnProperty,ke=Object.prototype.propertyIsEnumerable;var re=(a,f,d)=>f in a?ge(a,f,{enumerable:!0,configurable:!0,writable:!0,value:d}):a[f]=d,O=(a,f)=>{for(var d in f||(f={}))he.call(f,d)&&re(a,d,f[d]);if(ne)for(var d of ne(f))ke.call(f,d)&&re(a,d,f[d]);return a},M=(a,f)=>be(a,ye(f));var Q=(a,f,d)=>new Promise((_,b)=>{var s=c=>{try{$(d.next(c))}catch(g){b(g)}},v=c=>{try{$(d.throw(c))}catch(g){b(g)}},$=c=>c.done?_(c.value):Promise.resolve(c.value).then(s,v);$((d=d.apply(a,f)).next())});import{d as K,c as ce,r as m,o as i,a as q,w as o,b as u,e,f as D,t as U,g as pe,_ as J,h as N,i as C,j as me,k as h,u as V,E as ee,F as S,l as B,m as we,n as _e,p as Ve,q as Fe,s as X,v as W,R as $e,x as te,y as Ce,z as le,A as xe,B as je,C as ue,D as De,G as A,H as Ie,I as Le,J as Se,K as Re,L as ze,M as ie,N as de,O as Ue,P as qe,Q as Ee}from"./index-Dxllzmhq.js";import{u as Be}from"./useModel-DQ5mSY-w.js";import{v as Ne}from"./setData-BXCfuNPN.js";import{r as Te}from"./index-DPt70WPP.js";import{t as Oe,c as Me,a as Pe}from"./transformation-Bi-fA-2P.js";const Ae={class:"EditortSuccess"},Ke={class:"btn-box"},Je=K({__name:"EditortSuccess",props:{modelValue:{type:Boolean,default:!1},title:{type:String,default:"数据提交成功！您可以继续编辑数据并再次提交。"}},emits:["update:modelValue"],setup(a,{emit:f}){const d=f,_=a,b=ce({get(){return _.modelValue},set(){d("update:modelValue",!1)}});function s(){pe.push({name:"userData"})}function v(){b.value=!1}return($,c)=>{const g=m("CircleCheckFilled"),k=m("el-icon"),p=m("el-button"),r=m("el-dialog");return i(),q(r,{modal:"","close-on-click-modal":!1,top:"33vh",style:{"border-radius":"8px"},modelValue:b.value,"onUpdate:modelValue":c[0]||(c[0]=R=>b.value=R),width:"396","destroy-on-close":""},{default:o(()=>[u("div",Ae,[e(k,null,{default:o(()=>[e(g)]),_:1}),D(" "+U(_.title)+" ",1),u("div",Ke,[e(p,{class:"btn",size:"large",onClick:v},{default:o(()=>[D(" 继续编辑 ")]),_:1}),e(p,{type:"primary",class:"btn",size:"large",onClick:s},{default:o(()=>[D(" 去查看 ")]),_:1})])])]),_:1},8,["modelValue"])}}}),Ge=J(Je,[["__scopeId","data-v-72ffcc8b"]]),He=a=>(X("data-v-0eeb7630"),a=a(),W(),a),Qe={class:"editor"},Xe={class:"flex gap-2"},We=He(()=>u("div",{class:"editor-container"},null,-1)),Ye=K({__name:"editor",props:{modelValue:{type:Object,default:()=>({})}},emits:["update:modelValue"],setup(a,{expose:f,emit:d}){const _=a,b=N({title:[{required:!0,message:"请输入名称",trigger:"blur"}],abstract:[{required:!0,message:"请输入摘要",trigger:"blur"}],keywords:[{required:!0,message:"请输入关键字",trigger:"blur"}],project:[{required:!0,message:"请选择一级机构",trigger:"change"}],subject:[{required:!0,message:"请选择二级机构",trigger:"change"}],visibility:[{required:!0,message:"请选择数据可见范围",trigger:"change"}]}),v=Be(_,"modelValue",d),$=C(""),c=C(!1),g=C(),k=x=>{v.value.keywords.splice(v.value.keywords.indexOf(x),1)},p=()=>{c.value=!0,_e(()=>{g.value.input.focus()})},r=()=>{$.value&&v.value.keywords.push($.value),c.value=!1,$.value=""},R=N([]),T=()=>{Ve({}).then(x=>{R.splice(0,R.length,...x.data)})},I=N([]);function L(x,l=!1){Fe(x).then(j=>{l||(v.value.subject=""),I.splice(0,I.length,...j.data)})}const z=C(null);return f({submitForm:x=>Q(this,null,function*(){x&&(yield x.validate(l=>l?Promise.resolve():Promise.reject()))}),ruleFormRef:z,getSecondaryOrg:L}),me(()=>{T()}),(x,l)=>{const j=m("el-form-item"),G=m("el-tag"),Y=m("el-button"),y=m("el-option"),n=m("el-select"),w=m("el-form");return i(),h("div",Qe,[e(w,{ref_key:"ruleFormRef",ref:z,model:V(v),size:"large",rules:b,"status-icon":"","label-width":"auto",class:"demo-ruleForm"},{default:o(()=>[e(j,{prop:"title",label:"名称"},{default:o(()=>[e(V(ee),{modelValue:V(v).title,"onUpdate:modelValue":l[0]||(l[0]=t=>V(v).title=t),modelModifiers:{trim:!0},type:"text",autocomplete:"off",placeholder:"请输入名称"},null,8,["modelValue"])]),_:1}),e(j,{prop:"abstract",label:"摘要"},{default:o(()=>[e(V(ee),{modelValue:V(v).abstract,"onUpdate:modelValue":l[1]||(l[1]=t=>V(v).abstract=t),modelModifiers:{trim:!0},type:"text",autocomplete:"off",placeholder:"请输入摘要"},null,8,["modelValue"])]),_:1}),e(j,{prop:"keywords",label:"关键词"},{default:o(()=>[u("div",Xe,[(i(!0),h(S,null,B(V(v).keywords,t=>(i(),q(G,{key:t,closable:"",class:"w-20",size:"large","disable-transitions":!1,onClose:E=>k(t)},{default:o(()=>[D(U(t),1)]),_:2},1032,["onClose"]))),128)),c.value?(i(),q(V(ee),{key:0,ref_key:"InputRef",ref:g,modelValue:$.value,"onUpdate:modelValue":l[2]||(l[2]=t=>$.value=t),modelModifiers:{trim:!0},class:"w-20",size:"default",onKeyup:we(r,["enter"]),onBlur:r},null,8,["modelValue"])):(i(),q(Y,{key:1,size:"default",class:"w-20",onClick:p},{default:o(()=>[D(" 添加关键词 ")]),_:1}))])]),_:1}),e(j,{prop:"project",label:"一级机构"},{default:o(()=>[e(n,{filterable:"",modelValue:V(v).project,"onUpdate:modelValue":l[3]||(l[3]=t=>V(v).project=t),placeholder:"请选择一级机构",onChange:L},{default:o(()=>[(i(!0),h(S,null,B(R,t=>(i(),q(y,{label:`${t.id}/${t.name}`,value:t.id,key:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),e(j,{prop:"subject",label:"二级机构"},{default:o(()=>[e(n,{filterable:"",modelValue:V(v).subject,"onUpdate:modelValue":l[4]||(l[4]=t=>V(v).subject=t),placeholder:"请选择二级机构"},{default:o(()=>[(i(!0),h(S,null,B(I,t=>(i(),q(y,{label:`${t.id}/${t.name}`,value:t.id,key:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),e(j,{prop:"visibility",label:"数据可见范围"},{default:o(()=>[e(n,{filterable:"",modelValue:V(v).visibility,"onUpdate:modelValue":l[5]||(l[5]=t=>V(v).visibility=t),placeholder:"请选择数据可见范围"},{default:o(()=>[(i(!0),h(S,null,B(V(Ne),t=>(i(),q(y,{label:t.label,value:t.value,key:t.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["model","rules"]),We])}}}),Ze=J(Ye,[["__scopeId","data-v-0eeb7630"]]),et=a=>(X("data-v-a49b4b8e"),a=a(),W(),a),tt={class:"editor"},lt=et(()=>u("p",null,"数据内容",-1)),at={class:"editor-container"},ot=K({__name:"editorBox",props:{templateData:{default:()=>[]}},setup(a){const f=a;return(d,_)=>(i(),h("div",tt,[lt,u("div",at,[(i(!0),h(S,null,B(f.templateData,b=>(i(),h("div",{key:b.id},[e(V($e),{blocks:b},null,8,["blocks"])]))),128))])]))}}),st=J(ot,[["__scopeId","data-v-a49b4b8e"]]),ve=a=>(X("data-v-a0705ddb"),a=a(),W(),a),nt={class:"upload-file"},rt={class:"upload-file-header"},ut=ve(()=>u("p",null,"上传写好的数据文件",-1)),it={class:"center"},dt={class:"flex"},ct=ve(()=>u("div",{class:"tips"}," 将填写好的文件上传至此处，上传的数据模板文件必须是相同的，此处展示上传文件说明 ",-1)),pt={class:"flex"},mt=["title"],_t=K({__name:"uploadFile",props:{ruleForm:{type:Object,default:()=>[]}},setup(a,{expose:f}){const d=a,_=C([]);function b(c){_.value.push(M(O({},c),{error:""}))}function s(c){_.value.splice(c,1)}function v(c){Ce({tid:d.ruleForm.tid,type:c}).then(g=>{const k=document.createElement("a");k.href="https://mgetest.micl.com.cn"+g.data,k.download="",k.click()})}function $(){if(_.value.length==0){le.warning("请先上传文件");return}const c=new FormData;c.append("tid",d.ruleForm.tid),c.append("sync","true"),_.value.forEach((p,r)=>{c.append("files",p.raw)});let g=_.value.length-1,k=setInterval(()=>{_.value[g].percentage+=1,_.value.forEach(p=>{p.percentage=_.value[g].percentage}),_.value[g].percentage>=70&&clearInterval(k)},1e3);return xe(c).then(p=>(k&&clearInterval(k),_.value.forEach(r=>{r.percentage=100}),Promise.resolve(p))).catch(p=>(console.log(p.data.code),k&&clearInterval(k),_.value.forEach(r=>{console.log(p.data.error_detail[r.name]),p.data.error_detail[r.name]&&(r.error=p.data.error_detail[r.name].error,r.percentage=0)}),Promise.reject(p)))}return f({uploadFileList:$}),(c,g)=>{const k=m("Download"),p=m("el-icon"),r=m("el-button"),R=m("el-dropdown-item"),T=m("el-dropdown-menu"),I=m("el-dropdown"),L=m("el-upload"),z=m("svg-icon"),P=m("el-progress"),x=m("DeleteFilled");return i(),h("div",nt,[u("div",rt,[ut,e(I,null,{dropdown:o(()=>[e(T,null,{default:o(()=>[e(R,{onClick:g[0]||(g[0]=l=>v("json"))},{default:o(()=>[D(" 下载JSON模板 ")]),_:1}),e(R,{onClick:g[1]||(g[1]=l=>v("xlsx"))},{default:o(()=>[D(" 下载EXCEL模板 ")]),_:1})]),_:1})]),default:o(()=>[e(r,{link:"",type:"primary"},{default:o(()=>[e(p,null,{default:o(()=>[e(k)]),_:1}),D(" 下载模板 ")]),_:1})]),_:1})]),u("div",it,[e(L,{class:"upload-demo",accept:".xls,.xlsx, .json, .zip, .rar",multiple:"","file-list":_.value,"auto-upload":!1,"show-file-list":!1,"on-change":b},{default:o(()=>[u("div",dt,[e(r,{plain:"",type:"primary",size:"large"},{default:o(()=>[D("上传")]),_:1}),ct])]),_:1},8,["file-list"]),(i(!0),h(S,null,B(_.value,(l,j)=>(i(),h("div",{key:j,class:"file-list"},[u("div",pt,[e(z,{name:"file",width:"20px",height:"20px"}),u("div",{class:te(["ellipsis1",{error:l.error!==""}]),title:l.error},U(l.name),11,mt)]),e(P,{percentage:l.percentage},null,8,["percentage"]),e(r,{link:"",onClick:G=>s(j)},{default:o(()=>[e(p,null,{default:o(()=>[e(x)]),_:1})]),_:2},1032,["onClick"])]))),128))])])}}}),vt=J(_t,[["__scopeId","data-v-a0705ddb"]]),ae=a=>(X("data-v-2f4fea49"),a=a(),W(),a),ft={class:"layoutCenter-contrnainer topCenter"},gt={class:"layoutCenter-header"},bt={key:0,class:"step"},yt={class:"step-name"},ht={class:"step-tips"},kt={class:"form"},wt={key:1},Vt=ae(()=>u("div",{class:"file-title isUpdate"},"基本信息",-1)),Ft={class:"file-content form"},$t=ae(()=>u("span",null,"所属分类",-1)),Ct=ae(()=>u("span",null,"模版名称",-1)),xt={class:"fonterBtn"},jt=K({__name:"create",setup(a){const f=[{label:"选择分类",tips:"选择数据所属的分类"},{label:"选择模板",tips:"选择符合数据格式的模板"},{label:"提交方式",tips:"选择提交方式"},{label:"填写数据",tips:"填写表格或者文件"}],d=C(0),_=je(),b=C(!0),s=C({category:"",keywords:[],project:"",subject:"",title:"",abstract:"",visibility:"",tid:"",categoryName:""}),v=N({category:[{required:!0,message:"请选择分类",trigger:"blur"}],tid:[{required:!0,message:"请选择模板",trigger:"blur"}]}),$=C(),c=()=>Q(this,null,function*(){let y=yield Te();return y.code===0&&($.value=Se(y.data,!1)),y}),g=N([]);function k(){return s.value.tid="",Re({category:s.value.category,meta_only:!0,per_page:100}).then(y=>{d.value=1,g.splice(0,g.length,...y.data.templates)})}const p=N([]),r=N([]);ue("editorFormData",r),ue("templateData",p);function R(y){ze(y).then(n=>{d.value=3;let w=ie(n.data.content,!1);p.splice(0,p.length,...w),r.splice(0,r.length),p.map(t=>{r.push(M(O({},t),{formId:de(20),childern:[]}))})})}const T=C(null),I=C(null),L=C(!1),z=C(""),P=C(null),x=y=>Q(this,null,function*(){y&&(yield y.validate(n=>{if(d.value=4,n){if(!b.value){P.value.uploadFileList().then(w=>{w.data.error?le.error(w.data.error):(L.value=!0,z.value="数据提交成功！您可以继续编辑数据并再次提交。")}).catch(w=>{w.data.code==2113&&(L.value=!0,z.value="部分数据提交成功！您可以继续编辑数据并再次提交。")});return}I.value.submitForm(I.value.ruleFormRef).then(()=>{let w={};w=Oe(r,w);let t=s.value.keywords.join(","),E={content:w,meta:M(O({},s.value),{keywords:t})},H=Me(r);if(H){le.error(` " ${H.style.name} " 不能为空,请填写后提交`);return}l.value?Ue(M(O({},E),{id:_.query.id})).then(()=>{L.value=!0,z.value="数据修改成功！您可以继续编辑数据并再次修改。"}):qe(E).then(oe=>{L.value=!0,z.value="数据提交成功！您可以继续编辑数据并再次提交。"})})}}))}),l=C(!1);function j(y){Ee(y).then(n=>{s.value.category=n.data.category_id+"",l.value=!0,k().then(w=>{s.value.tid=n.data.tid,s.value.title=n.data.title,s.value.abstract=n.data.abstract,s.value.keywords=n.data.keywords,s.value.project=n.data.project,s.value.subject=n.data.subject,s.value.visibility=n.data.visibility,s.value.categoryName=n.data.category,console.log(I.value),_e(()=>{I.value.getSecondaryOrg(s.value.project,!0)});let t=ie(n.data.template.content,!1);p.splice(0,p.length,...t),r.splice(0,r.length),p.map(E=>{r.push(M(O({},E),{formId:de(20),childern:[]}))}),Pe(t,n.data.content,r),console.log(r)})})}function G(){pe.go(-1)}me(()=>{c(),_.query.id&&j(_.query.id)});const Y=ce(()=>g.find(y=>y.id==s.value.tid));return(y,n)=>{var se;const w=m("el-button"),t=m("el-tree-select"),E=m("el-form-item"),H=m("el-option"),oe=m("el-select"),fe=m("el-form");return i(),h(S,null,[u("div",ft,[u("div",gt,[u("p",null,U(l.value?"编辑数据":"上传数据"),1),l.value?(i(),q(w,{key:0,icon:V(De),size:"large",onClick:G},{default:o(()=>[D(" 返回 ")]),_:1},8,["icon"])):A("",!0)]),l.value?A("",!0):(i(),h("div",bt,[(i(),h(S,null,B(f,(F,Z)=>u("div",{key:Z,class:"item"},[u("div",{class:te(["step-number",{active:Z<d.value}])}," 0"+U(Z+1),3),u("div",yt,U(F.label),1),u("div",ht,U(F.tips),1)])),64))])),Ie(u("div",kt,[e(fe,{ref_key:"ruleFormRef",ref:T,model:s.value,size:"large",rules:v,"status-icon":"","label-width":"auto",class:"demo-ruleForm"},{default:o(()=>[e(E,{prop:"category",label:"选择分类"},{default:o(()=>[e(t,{filterable:"",modelValue:s.value.category,"onUpdate:modelValue":n[0]||(n[0]=F=>s.value.category=F),disabled:l.value,data:$.value,"default-expanded-keys":[s.value.category],"default-checked-keys":[s.value.category],"node-key":"value",onChange:k,size:"large","check-on-click-node":"","check-strictly":""},null,8,["modelValue","disabled","data","default-expanded-keys","default-checked-keys"])]),_:1}),e(E,{prop:"tid",label:"选择模板"},{default:o(()=>[e(oe,{filterable:"",modelValue:s.value.tid,"onUpdate:modelValue":n[1]||(n[1]=F=>s.value.tid=F),disabled:l.value,placeholder:"请选择模板",onChange:R},{default:o(()=>[(i(!0),h(S,null,B(g,F=>(i(),q(H,{label:F.title,value:F.id,key:F.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","disabled"])]),_:1}),e(E,{prop:"password",label:"上传方式"},{default:o(()=>[e(w,{type:b.value?"primary":"",class:"btn",size:"large",disabled:l.value,onClick:n[2]||(n[2]=F=>b.value=!0)},{default:o(()=>[D(" 表单上传 ")]),_:1},8,["type","disabled"]),e(w,{type:b.value?"":"primary",class:"btn",size:"large",disabled:l.value,onClick:n[3]||(n[3]=F=>b.value=!1)},{default:o(()=>[D(" 文件上传 ")]),_:1},8,["type","disabled"])]),_:1})]),_:1},8,["model","rules"])],512),[[Le,!l.value]]),l.value?(i(),h("div",wt,[Vt,u("div",Ft,[u("div",null,[$t,u("span",null,U(s.value.categoryName),1)]),u("div",null,[Ct,u("span",null,U((se=Y.value)==null?void 0:se.title),1)])])])):A("",!0),s.value.tid!=""?(i(),h("div",{key:2,class:te(["file-title",{isUpdate:l.value}])},U(l.value?"数据信息":"填写数据"),3)):A("",!0),s.value.tid!=""?(i(),h(S,{key:3},[b.value?(i(),h(S,{key:0},[e(Ze,{ref_key:"editorRef",ref:I,modelValue:s.value,"onUpdate:modelValue":n[4]||(n[4]=F=>s.value=F)},null,8,["modelValue"]),e(st,{templateData:r},null,8,["templateData"])],64)):(i(),q(vt,{key:1,ref_key:"uploadFileList",ref:P,ruleForm:s.value},null,8,["ruleForm"]))],64)):A("",!0),u("div",xt,[e(w,{type:"primary",class:"btn",size:"large",onClick:n[5]||(n[5]=F=>x(T.value))},{default:o(()=>[D(" 提交 ")]),_:1})])]),e(Ge,{modelValue:L.value,"onUpdate:modelValue":n[6]||(n[6]=F=>L.value=F),title:z.value},null,8,["modelValue","title"])],64)}}}),Ut=J(jt,[["__scopeId","data-v-2f4fea49"]]);export{Ut as default};
